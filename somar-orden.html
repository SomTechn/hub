<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3a8a">
    <title>Somar Orden - Cliente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        h1, h2, h3, .font-display {
            font-family: 'Poppins', sans-serif;
        }

        #app {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
        }

        .btn-primary:active {
            transform: scale(0.96);
        }

        .btn-blue {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            transition: all 0.2s ease;
        }

        .btn-blue:active {
            transform: scale(0.96);
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            display: inline-block;
        }

        .status-received { background: #dbeafe; color: #1e40af; }
        .status-in_progress { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-delivered { background: #e5e7eb; color: #374151; }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .order-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .order-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="h-full flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800">
            <div class="text-center px-4">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-lg">Cargando...</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwo--xgtd1eu9Hy3EeOQSEwomVTAlOhFhsEHYdMP0xH9LWQoAEgTROHPVURmoa3TaB67g/exec'
        };

        // ==================== ESTADO GLOBAL ====================
        let state = {
            screen: 'loading',
            businessSlug: null,
            business: null,
            customer: null,
            phone: '',
            verificationCode: '',
            isVerified: false,
            services: [],
            myOrders: [],
            orderFilter: 'pending',
            loading: true
        };

        // ==================== FUNCIONES DE GOOGLE SHEETS API ====================
        
        async function callAPI(action, params = {}) {
            try {
                const urlParams = new URLSearchParams({
                    action: action,
                    ...params
                });

                const response = await fetch(`${CONFIG.SCRIPT_URL}?${urlParams}`);
                const result = await response.json();
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        function getBusinessSlugFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('business') || 'demo-taller';
        }

        async function loadBusiness() {
            try {
                const result = await callAPI('getBusiness', { slug: state.businessSlug });
                
                if (result.success) {
                    state.business = result.data;
                    document.documentElement.style.setProperty('--primary-color', result.data.primary_color);
                    document.documentElement.style.setProperty('--accent-color', result.data.accent_color);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error loading business:', error);
                state.error = 'Negocio no encontrado';
            }
        }

        async function loadServices() {
            try {
                const result = await callAPI('getServices', { business_id: state.business.id });
                if (result.success) {
                    state.services = result.data || [];
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        async function sendVerificationCode(phone) {
            try {
                const result = await callAPI('sendCode', { phone: phone });
                
                if (result.success) {
                    // SOLO PARA DESARROLLO: mostrar c√≥digo
                    alert(`C√≥digo de verificaci√≥n: ${result.data.code}\n\n(En producci√≥n se enviar√° por WhatsApp)`);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error sending code:', error);
                return false;
            }
        }

        async function verifyCodeAPI(phone, code) {
            try {
                const result = await callAPI('verifyCode', { phone: phone, code: code });
                return result.success;
            } catch (error) {
                console.error('Error verifying code:', error);
                return false;
            }
        }

        async function loginOrRegister(phone) {
            try {
                const result = await callAPI('getCustomer', {
                    phone: phone,
                    business_id: state.business.id
                });

                if (result.success && result.data) {
                    state.customer = result.data;
                    state.isVerified = true;
                    await loadMyOrders();
                    state.screen = 'menu';
                } else {
                    state.screen = 'register';
                }
                
                render();
            } catch (error) {
                console.error('Error in login:', error);
                state.screen = 'register';
                render();
            }
        }

        async function registerCustomer(name, phone) {
            try {
                const result = await callAPI('registerCustomer', {
                    name: name,
                    phone: phone,
                    business_id: state.business.id
                });

                if (result.success) {
                    state.customer = result.data;
                    state.isVerified = true;
                    await loadMyOrders();
                    state.screen = 'menu';
                    render();
                }
            } catch (error) {
                console.error('Error registering:', error);
                alert('Error al registrar');
            }
        }

        async function loadMyOrders() {
            try {
                const result = await callAPI('getCustomerOrders', {
                    customer_id: state.customer.id
                });

                if (result.success) {
                    state.myOrders = result.data || [];
                }
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        async function createOrder(orderData) {
            try {
                const service = state.services.find(s => s.id === orderData.service_id);
                const promisedDelivery = new Date();
                promisedDelivery.setHours(promisedDelivery.getHours() + service.estimated_hours);

                const result = await callAPI('createOrder', {
                    business_id: state.business.id,
                    customer_id: state.customer.id,
                    service_name: service.name,
                    price: orderData.price,
                    notes: orderData.notes || '',
                    created_at: new Date().toISOString(),
                    promised_delivery: promisedDelivery.toISOString(),
                    status: 'received'
                });

                if (result.success) {
                    await loadMyOrders();
                    return result.data;
                }
                throw new Error('Error creating order');
            } catch (error) {
                console.error('Error creating order:', error);
                throw error;
            }
        }

        // ==================== FUNCIONES DE UTILIDAD ====================
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = date - now;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffMs < 0) {
                return '<span class="text-red-600 font-bold">¬°Vencido!</span>';
            } else if (diffHours < 24) {
                return `En ${diffHours}h`;
            } else {
                return `En ${diffDays}d ${diffHours % 24}h`;
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-HN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'received': 'Recibido',
                'in_progress': 'En Proceso',
                'ready': 'Listo para Recoger',
                'delivered': 'Entregado'
            };
            return statusMap[status] || status;
        }

        function getProgressPercentage(status) {
            const progressMap = {
                'received': 25,
                'in_progress': 50,
                'ready': 75,
                'delivered': 100
            };
            return progressMap[status] || 0;
        }

        function getFilteredOrders() {
            switch(state.orderFilter) {
                case 'pending':
                    return state.myOrders.filter(o => o.status !== 'delivered');
                case 'delivered':
                    return state.myOrders.filter(o => o.status === 'delivered');
                default:
                    return state.myOrders;
            }
        }

        // ==================== COMPONENTES DE INTERFAZ ====================
        
        function LoginScreen() {
            return `
                <div class="h-full flex flex-col bg-gradient-to-br from-blue-900 to-blue-800">
                    <!-- Header -->
                    <div class="flex-shrink-0 text-center pt-12 pb-8 px-4">
                        ${state.business?.logo_url ? 
                            `<img src="${state.business.logo_url}" alt="${state.business.name}" class="w-24 h-24 mx-auto mb-4 rounded-full object-cover border-4 border-white shadow-xl">` 
                            : '<div class="text-6xl mb-4">üìã</div>'
                        }
                        <h1 class="text-3xl font-display font-bold text-white mb-2">${state.business?.name || 'Somar Orden'}</h1>
                        <p class="text-white opacity-90">${state.business?.description || 'Sistema de √ìrdenes de Servicio'}</p>
                    </div>

                    <!-- Login Form -->
                    <div class="flex-1 overflow-y-auto scrollable px-4 pb-8">
                        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-2xl p-6">
                            <div class="text-center mb-6">
                                <h2 class="text-2xl font-display font-bold text-gray-800 mb-2">Iniciar Sesi√≥n</h2>
                                <p class="text-sm text-gray-600">Ingresa tu n√∫mero de celular</p>
                            </div>

                            <form id="loginForm" class="space-y-4">
                                <!-- N√∫mero de Celular -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Celular (WhatsApp)</label>
                                    <div class="flex gap-2">
                                        <span class="px-4 py-3 bg-gray-100 border-2 border-gray-300 rounded-lg font-bold">+504</span>
                                        <input 
                                            type="tel"
                                            id="phoneInput"
                                            required
                                            placeholder="9999-9999"
                                            pattern="[0-9]{8}"
                                            maxlength="8"
                                            class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-bold focus:border-blue-500 focus:outline-none">
                                    </div>
                                </div>

                                ${state.phone ? `
                                    <!-- C√≥digo de Verificaci√≥n -->
                                    <div class="slide-up">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">C√≥digo de Verificaci√≥n</label>
                                        <input 
                                            type="text"
                                            id="codeInput"
                                            required
                                            placeholder="000000"
                                            pattern="[0-9]{6}"
                                            maxlength="6"
                                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-bold text-center focus:border-blue-500 focus:outline-none">
                                        <p class="text-xs text-gray-500 mt-2 text-center">
                                            C√≥digo enviado a tu WhatsApp
                                        </p>
                                    </div>
                                ` : ''}

                                <!-- Bot√≥n -->
                                <button 
                                    type="submit"
                                    class="btn-primary text-white w-full py-4 rounded-xl font-bold text-lg">
                                    ${state.phone ? '‚úÖ Verificar C√≥digo' : 'üì± Enviar C√≥digo'}
                                </button>

                                ${state.phone ? `
                                    <button 
                                        type="button"
                                        onclick="resetLogin()"
                                        class="w-full text-center text-sm text-gray-600 hover:text-gray-800 py-2">
                                        ‚Üê Cambiar n√∫mero
                                    </button>
                                ` : ''}
                            </form>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="flex-shrink-0 text-center text-white py-4 px-4">
                        <p class="text-xs opacity-75">‚ö° Powered by <strong>Somar Ecosystem</strong> üá≠üá≥</p>
                    </div>
                </div>
            `;
        }

        function RegisterScreen() {
            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <!-- Header -->
                    <div class="flex-shrink-0 bg-gradient-to-r from-blue-900 to-blue-800 text-white px-4 py-4 shadow-lg">
                        <div class="max-w-4xl mx-auto text-center">
                            <h1 class="text-2xl font-display font-bold">Nuevo Cliente</h1>
                            <p class="text-sm opacity-90">Completa tu registro</p>
                        </div>
                    </div>

                    <!-- Form -->
                    <div class="flex-1 overflow-y-auto scrollable px-4 py-6">
                        <div class="max-w-md mx-auto">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="text-center mb-6">
                                    <div class="text-5xl mb-3">üë§</div>
                                    <h2 class="text-xl font-bold text-gray-800">¬°Bienvenido!</h2>
                                    <p class="text-sm text-gray-600">Es tu primera vez en ${state.business.name}</p>
                                </div>

                                <form id="registerForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Nombre Completo *</label>
                                        <input 
                                            type="text"
                                            id="nameInput"
                                            required
                                            placeholder="Ej: Juan P√©rez"
                                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Celular</label>
                                        <input 
                                            type="text"
                                            value="+504 ${state.phone}"
                                            disabled
                                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-600">
                                    </div>

                                    <button 
                                        type="submit"
                                        class="btn-primary text-white w-full py-4 rounded-xl font-bold text-lg">
                                        ‚úÖ Registrarme
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function MenuScreen() {
            const filteredOrders = getFilteredOrders();
            
            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <!-- Header -->
                    <div class="flex-shrink-0 bg-gradient-to-r from-blue-900 to-blue-800 text-white px-4 py-4 shadow-lg">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <h1 class="text-xl font-display font-bold">Hola, ${state.customer.name}</h1>
                                    <p class="text-sm opacity-90">${state.business.name}</p>
                                </div>
                                <button onclick="logout()" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg font-bold text-sm">
                                    Salir
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="flex-shrink-0 bg-white shadow px-4 py-3">
                        <div class="flex gap-2 max-w-4xl mx-auto">
                            <button 
                                onclick="setOrderFilter('pending')"
                                class="${state.orderFilter === 'pending' ? 'bg-blue-900 text-white' : 'bg-gray-200 text-gray-700'} px-4 py-2 rounded-lg font-bold text-sm flex-1">
                                Pendientes (${state.myOrders.filter(o => o.status !== 'delivered').length})
                            </button>
                            <button 
                                onclick="setOrderFilter('delivered')"
                                class="${state.orderFilter === 'delivered' ? 'bg-blue-900 text-white' : 'bg-gray-200 text-gray-700'} px-4 py-2 rounded-lg font-bold text-sm flex-1">
                                Entregados (${state.myOrders.filter(o => o.status === 'delivered').length})
                            </button>
                        </div>
                    </div>

                    <!-- Lista de √ìrdenes -->
                    <div class="flex-1 overflow-y-auto scrollable px-4 py-4">
                        <div class="max-w-4xl mx-auto space-y-3">
                            ${filteredOrders.length === 0 ? `
                                <div class="text-center py-12">
                                    <div class="text-5xl mb-4">üìã</div>
                                    <p class="text-gray-500 text-lg">No tienes √≥rdenes ${state.orderFilter === 'pending' ? 'pendientes' : 'entregadas'}</p>
                                    ${state.orderFilter === 'pending' ? `
                                        <button onclick="goToNewOrder()" class="btn-primary text-white px-6 py-3 rounded-lg font-bold mt-4">
                                            ‚ûï Crear Nueva Orden
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${filteredOrders.map(order => `
                                <div class="order-card bg-white rounded-lg shadow-lg p-4" onclick='viewOrderDetails(${JSON.stringify(order).replace(/'/g, "\\'")})'> 
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <h3 class="font-bold text-lg text-gray-800">${order.order_number}</h3>
                                            <p class="text-sm text-gray-600">${order.service_name}</p>
                                        </div>
                                        <span class="status-badge status-${order.status}">
                                            ${getStatusText(order.status)}
                                        </span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${getProgressPercentage(order.status)}%"></div>
                                        </div>
                                    </div>

                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-600">üìÖ ${formatDateTime(order.created_at)}</span>
                                        <span class="font-bold text-green-600">L ${order.price.toFixed(2)}</span>
                                    </div>

                                    ${order.status !== 'delivered' ? `
                                        <div class="mt-2 text-xs text-gray-500">
                                            Entrega: ${formatDate(order.promised_delivery)}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Bot√≥n Nueva Orden -->
                    ${filteredOrders.length > 0 && state.orderFilter === 'pending' ? `
                        <div class="flex-shrink-0 bg-white border-t shadow-lg px-4 py-3">
                            <button 
                                onclick="goToNewOrder()"
                                class="btn-primary text-white w-full max-w-4xl mx-auto block py-4 rounded-xl font-bold text-lg">
                                ‚ûï Nueva Orden
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function NewOrderScreen() {
            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <!-- Header -->
                    <div class="flex-shrink-0 bg-gradient-to-r from-blue-900 to-blue-800 text-white px-4 py-3 shadow-lg">
                        <div class="flex items-center justify-between max-w-4xl mx-auto">
                            <button onclick="backToMenu()" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg font-bold text-sm">
                                ‚Üê Volver
                            </button>
                            <h1 class="text-lg font-display font-bold">Nueva Orden</h1>
                            <div class="w-16"></div>
                        </div>
                    </div>

                    <!-- Form -->
                    <div class="flex-1 overflow-y-auto scrollable px-4 py-6">
                        <div class="max-w-2xl mx-auto">
                            <form id="newOrderForm" class="bg-white rounded-xl shadow-lg p-6 space-y-4">
                                <!-- Servicio -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Servicio *</label>
                                    <select 
                                        id="serviceSelect"
                                        required
                                        onchange="updateServiceInfo()"
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                        <option value="">Seleccionar...</option>
                                        ${state.services.map(s => `
                                            <option value="${s.id}" data-price="${s.price}" data-hours="${s.estimated_hours}">
                                                ${s.name} - L ${s.price.toFixed(2)}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- Info del Servicio -->
                                <div id="serviceInfo" class="hidden bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="text-gray-600">Tiempo Estimado:</p>
                                            <p class="font-bold text-blue-900" id="estimatedTime"></p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600">Entrega Aprox:</p>
                                            <p class="font-bold text-blue-900" id="estimatedDelivery"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notas -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Detalles / Notas (Opcional)</label>
                                    <textarea 
                                        id="orderNotes"
                                        rows="4"
                                        placeholder="Describe los detalles de tu trabajo..."
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none resize-none"></textarea>
                                </div>

                                <!-- Precio -->
                                <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-700 font-bold">Total a Pagar:</span>
                                        <span class="text-2xl font-bold text-green-600" id="orderPrice">L 0.00</span>
                                    </div>
                                </div>

                                <!-- Bot√≥n -->
                                <button 
                                    type="submit"
                                    class="btn-primary text-white w-full py-4 rounded-xl font-bold text-lg">
                                    ‚úÖ Crear Orden
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function OrderDetailsModal(order) {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in" onclick="closeModal(event)">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto scrollable" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-900 to-blue-800 text-white px-6 py-4 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-display font-bold">Orden ${order.order_number}</h2>
                                <button onclick="closeModal()" class="text-2xl">&times;</button>
                            </div>
                        </div>

                        <div class="p-6">
                            <!-- Estado -->
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-3">
                                    ${order.status === 'received' ? 'üì•' : ''}
                                    ${order.status === 'in_progress' ? 'üîß' : ''}
                                    ${order.status === 'ready' ? '‚úÖ' : ''}
                                    ${order.status === 'delivered' ? 'üéâ' : ''}
                                </div>
                                <span class="status-badge status-${order.status} text-lg">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>

                            <!-- Progreso -->
                            <div class="mb-6">
                                <div class="progress-bar mb-2">
                                    <div class="progress-fill" style="width: ${getProgressPercentage(order.status)}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>Recibido</span>
                                    <span>Proceso</span>
                                    <span>Listo</span>
                                    <span>Entregado</span>
                                </div>
                            </div>

                            <!-- Detalles -->
                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between py-2 border-b">
                                    <span class="text-gray-600">Servicio:</span>
                                    <span class="font-bold">${order.service_name}</span>
                                </div>
                                <div class="flex justify-between py-2 border-b">
                                    <span class="text-gray-600">Precio:</span>
                                    <span class="font-bold text-green-600 text-lg">L ${order.price.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between py-2 border-b">
                                    <span class="text-gray-600">Creada:</span>
                                    <span class="font-bold text-sm">${formatDateTime(order.created_at)}</span>
                                </div>
                                <div class="flex justify-between py-2 border-b">
                                    <span class="text-gray-600">Entrega Prometida:</span>
                                    <span class="font-bold text-sm">${formatDateTime(order.promised_delivery)}</span>
                                </div>
                                ${order.notes ? `
                                    <div class="py-2 border-b">
                                        <span class="text-gray-600 text-sm">Notas:</span>
                                        <p class="text-sm mt-1">${order.notes}</p>
                                    </div>
                                ` : ''}
                            </div>

                            ${order.status === 'ready' ? `
                                <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 text-center">
                                    <p class="text-green-800 font-bold text-lg">‚úÖ ¬°Tu trabajo est√° listo!</p>
                                    <p class="text-sm text-green-700 mt-1">Puedes pasar a recogerlo</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== FUNCIONES DE NAVEGACI√ìN ====================
        
        async function handleLogin(e) {
            e.preventDefault();
            
            if (!state.phone) {
                const phoneInput = document.getElementById('phoneInput');
                const phone = phoneInput.value.trim();
                
                if (phone.length !== 8) {
                    alert('Ingresa un n√∫mero v√°lido de 8 d√≠gitos');
                    return;
                }

                const sent = await sendVerificationCode(phone);
                if (sent) {
                    state.phone = phone;
                    render();
                }
            } else {
                const codeInput = document.getElementById('codeInput');
                const code = codeInput.value.trim();
                
                const verified = await verifyCodeAPI(state.phone, code);
                if (verified) {
                    await loginOrRegister(state.phone);
                } else {
                    alert('C√≥digo incorrecto o expirado');
                }
            }
        }

        function resetLogin() {
            state.phone = '';
            render();
        }

        async function handleRegister(e) {
            e.preventDefault();
            const nameInput = document.getElementById('nameInput');
            await registerCustomer(nameInput.value.trim(), state.phone);
        }

        function logout() {
            state.customer = null;
            state.isVerified = false;
            state.phone = '';
            state.myOrders = [];
            state.screen = 'login';
            render();
        }

        function setOrderFilter(filter) {
            state.orderFilter = filter;
            render();
        }

        function goToNewOrder() {
            state.screen = 'new-order';
            render();
        }

        function backToMenu() {
            state.screen = 'menu';
            loadMyOrders();
            render();
        }

        function viewOrderDetails(order) {
            const modal = OrderDetailsModal(order);
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function closeModal(event) {
            if (event && event.target === event.currentTarget) {
                event.target.remove();
            } else if (!event) {
                document.querySelectorAll('.fixed.inset-0').forEach(m => m.remove());
            }
        }

        function updateServiceInfo() {
            const select = document.getElementById('serviceSelect');
            const infoDiv = document.getElementById('serviceInfo');
            const priceSpan = document.getElementById('orderPrice');
            
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const hours = parseInt(selectedOption.dataset.hours);
                const price = parseFloat(selectedOption.dataset.price);
                
                const delivery = new Date();
                delivery.setHours(delivery.getHours() + hours);
                
                document.getElementById('estimatedTime').textContent = `${hours} horas`;
                document.getElementById('estimatedDelivery').textContent = formatDateTime(delivery.toISOString());
                priceSpan.textContent = `L ${price.toFixed(2)}`;
                
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
                priceSpan.textContent = 'L 0.00';
            }
        }

        async function handleNewOrder(e) {
            e.preventDefault();
            
            const serviceId = document.getElementById('serviceSelect').value;
            const notes = document.getElementById('orderNotes').value;
            const service = state.services.find(s => s.id === serviceId);
            
            if (!serviceId) {
                alert('Selecciona un servicio');
                return;
            }

            try {
                const order = await createOrder({
                    service_id: serviceId,
                    price: service.price,
                    notes: notes
                });
                
                alert(`‚úÖ Orden ${order.order_number} creada exitosamente`);
                backToMenu();
            } catch (error) {
                alert('Error al crear la orden');
            }
        }

        // ==================== EVENT LISTENERS ====================
        
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('submit', async (e) => {
                if (e.target.id === 'loginForm') {
                    await handleLogin(e);
                }
                if (e.target.id === 'registerForm') {
                    await handleRegister(e);
                }
                if (e.target.id === 'newOrderForm') {
                    await handleNewOrder(e);
                }
            });
        });

        // ==================== RENDERIZADO ====================
        
        function render() {
            const app = document.getElementById('app');
            
            let content = '';
            switch(state.screen) {
                case 'loading':
                    content = `<div class="h-full flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800 fade-in">
                        <div class="text-center px-4">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-white text-lg">Cargando...</p>
                        </div>
                    </div>`;
                    break;
                case 'login':
                    content = LoginScreen();
                    break;
                case 'register':
                    content = RegisterScreen();
                    break;
                case 'menu':
                    content = MenuScreen();
                    break;
                case 'new-order':
                    content = NewOrderScreen();
                    break;
            }
            
            app.innerHTML = content;
        }

        // ==================== INICIALIZACI√ìN ====================
        
        async function init() {
            try {
                state.businessSlug = getBusinessSlugFromURL();
                await loadBusiness();
                await loadServices();
                
                state.loading = false;
                state.screen = 'login';
                render();
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('Error al cargar la aplicaci√≥n. Verifica que hayas configurado el SCRIPT_URL.');
            }
        }

        init();
    </script>
</body>
</html>
