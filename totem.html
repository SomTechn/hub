<!DOCTYPE HTML>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Somar Totem - Autoservicio</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        h1, h2, h3, .font-display {
            font-family: 'Poppins', sans-serif;
        }

        /* Contenedor principal - ocupa toda la altura */
        #app {
            height: 100vh;
            height: 100dvh; /* Altura din√°mica del viewport en m√≥viles */
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
        }

        .btn-primary:active {
            transform: scale(0.96);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--primary-color, #1e3a8a) 0%, var(--primary-dark, #1e40af) 100%);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.25);
            transition: all 0.2s ease;
        }

        .btn-secondary:active {
            transform: scale(0.96);
        }

        .product-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .tab-active {
            background: linear-gradient(135deg, var(--primary-color, #1e3a8a) 0%, var(--primary-dark, #1e40af) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
        }

        .tab-inactive {
            background: white;
            color: var(--primary-color, #1e3a8a);
            border: 2px solid #e5e7eb;
        }

        .cart-badge {
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .welcome-bg {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.9) 100%),
                        url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect fill="%231e3a8a" width="100" height="100"/><circle cx="50" cy="50" r="40" fill="%231e40af" opacity="0.1"/></svg>');
            background-size: cover, 100px 100px;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color, #1e3a8a);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quantity-btn {
            transition: all 0.15s ease;
        }

        .quantity-btn:active {
            transform: scale(0.9);
        }

        .bill-option {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .bill-option:active {
            transform: scale(0.96);
        }

        .bill-selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .closed-overlay {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }

        /* Scroll solo en √°reas espec√≠ficas */
        .scrollable-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Fix para altura en m√≥viles */
        @supports (-webkit-touch-callout: none) {
            #app {
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Loading inicial -->
        <div class="h-full flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800">
            <div class="text-center px-4">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-base sm:text-lg">Cargando Somar Totem...</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const CONFIG = {
            SUPABASE_URL: 'https://osmghhkskiqrzxnbnsyf.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zbWdoaGtza2lxcnp4bmJuc3lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjM0MTgsImV4cCI6MjA4NDY5OTQxOH0.6Ikhw3xTiAs2lAKy_7WpeZLPJ4V0az_FZ7ETWUrKEjo',
            BUSINESS_SLUG: 'demo-restaurant',
            BILL_OPTIONS: [50, 100, 200, 500]
        };

        // Inicializar Supabase
        const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // ==================== ESTADO DE LA APLICACI√ìN ====================
        let state = {
            screen: 'loading',
            business: null,
            categories: [],
            products: [],
            activeCategory: null,
            cart: [],
            customerName: '',
            customerPhone: '',
            selectedBill: null,
            orderNumber: null,
            isOpen: false,
            loading: true,
            error: null
        };

        // ==================== FUNCIONES DE SUPABASE ====================
        async function loadBusinessData() {
            try {
                state.loading = true;
                state.error = null;
                
                const { data, error } = await supabaseClient.rpc('get_business_data', {
                    business_slug: CONFIG.BUSINESS_SLUG
                });

                if (error) throw error;
                if (!data) throw new Error('Negocio no encontrado');

                state.business = data.business;
                state.categories = data.categories || [];
                state.products = data.products || [];
                state.isOpen = data.is_open;
                state.activeCategory = state.categories[0]?.id || null;

                document.documentElement.style.setProperty('--primary-color', state.business.primary_color);
                document.documentElement.style.setProperty('--accent-color', state.business.accent_color);

                state.loading = false;
                state.screen = state.isOpen ? 'welcome' : 'closed';
                
            } catch (error) {
                console.error('Error loading business:', error);
                state.error = error.message;
                state.loading = false;
                state.screen = 'error';
            } finally {
                render();
            }
        }

        async function createOrder() {
            try {
                let customerId = null;
                
                if (state.customerPhone) {
                    let { data: existingCustomer, error: searchError } = await supabaseClient
                        .from('customers')
                        .select('*')
                        .eq('phone', state.customerPhone)
                        .maybeSingle();

                    if (existingCustomer) {
                        customerId = existingCustomer.id;
                    } else {
                        const { data: newCustomer, error } = await supabaseClient
                            .from('customers')
                            .insert({
                                phone: state.customerPhone,
                                name: state.customerName
                            })
                            .select()
                            .single();

                        if (error) throw error;
                        customerId = newCustomer.id;
                    }
                }

                const total = getCartTotal();
                let pointsEarned = 0;
                
                if (state.business.points_enabled && customerId) {
                    pointsEarned = Math.floor(total / state.business.points_ratio);
                }

                const { data: order, error } = await supabaseClient
                    .from('orders')
                    .insert({
                        business_id: state.business.id,
                        customer_id: customerId,
                        items: state.cart,
                        subtotal: total,
                        total: total,
                        payment_method: 'cash',
                        payment_amount: state.selectedBill,
                        change_amount: state.selectedBill - total,
                        points_earned: pointsEarned,
                        status: 'pending'
                    })
                    .select()
                    .single();

                if (error) throw error;

                state.orderNumber = order.order_number;
                state.screen = 'confirmation';
                render();

            } catch (error) {
                console.error('Error creating order:', error);
                alert('Error al crear la orden. Por favor intenta nuevamente.');
            }
        }

        // ==================== FUNCIONES DE UTILIDAD ====================
        function getCartTotal() {
            return state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        function getCartItemCount() {
            return state.cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        function addToCart(product) {
            const existingItem = state.cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.cart.push({ ...product, quantity: 1 });
            }
            render();
        }

        function updateQuantity(productId, change) {
            const item = state.cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    state.cart = state.cart.filter(i => i.id !== productId);
                }
                render();
            }
        }

        function resetApp() {
            state = {
                ...state,
                screen: 'welcome',
                cart: [],
                customerName: '',
                customerPhone: '',
                selectedBill: null,
                orderNumber: null
            };
            render();
        }

        function getProductsByCategory(categoryId) {
            return state.products.filter(p => p.category_id === categoryId);
        }

        // ==================== COMPONENTES DE LA INTERFAZ ====================
        
        function LoadingScreen() {
            return `
                <div class="h-full flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800 fade-in px-4">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white text-base sm:text-lg">Cargando...</p>
                    </div>
                </div>
            `;
        }

        function ErrorScreen() {
            return `
                <div class="h-full flex items-center justify-center bg-gradient-to-br from-red-900 to-red-800 px-4 fade-in">
                    <div class="text-center bg-white rounded-2xl p-6 sm:p-8 max-w-md">
                        <div class="text-4xl sm:text-5xl mb-4">‚ùå</div>
                        <h1 class="text-2xl sm:text-3xl font-display font-bold text-gray-800 mb-3">Error</h1>
                        <p class="text-base sm:text-lg text-gray-600 mb-4">${state.error || 'No se pudo cargar el negocio'}</p>
                        <button onclick="location.reload()" class="btn-primary text-white px-6 py-3 rounded-xl font-bold text-base sm:text-lg">
                            Reintentar
                        </button>
                    </div>
                </div>
            `;
        }

        function ClosedScreen() {
            const business = state.business;
            return `
                <div class="h-full flex items-center justify-center closed-overlay px-4 fade-in">
                    <div class="text-center bg-white rounded-2xl p-6 sm:p-8 max-w-md">
                        ${business.logo_url ? `<img src="${business.logo_url}" alt="${business.name}" class="w-24 h-24 mx-auto mb-4 rounded-full object-cover">` : ''}
                        <h1 class="text-2xl sm:text-3xl font-display font-bold text-gray-800 mb-3">${business.name}</h1>
                        <div class="text-5xl sm:text-6xl mb-4">üïí</div>
                        <h2 class="text-xl sm:text-2xl font-display font-bold text-gray-700 mb-3">Estamos Cerrados</h2>
                        <p class="text-base sm:text-lg text-gray-600 mb-4">
                            Nuestro horario es:<br>
                            <strong>${business.opening_time} - ${business.closing_time}</strong>
                        </p>
                        <p class="text-sm text-gray-500">¬°Vuelve pronto!</p>
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <p class="text-xs text-gray-400">
                                ‚ö° Powered by <strong>Somar Totem</strong><br class="sm:hidden">
                                <span class="hidden sm:inline"> ‚Ä¢ </span>Part of <strong>Somar Ecosystem</strong>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function WelcomeScreen() {
            const business = state.business;
            return `
                <div class="welcome-bg h-full flex flex-col items-center justify-center px-4 fade-in">
                    <div class="text-center mb-6 sm:mb-8">
                        <div class="bg-white rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 inline-block shadow-2xl">
                            ${business.logo_url ? 
                                `<img src="${business.logo_url}" alt="${business.name}" class="w-20 h-20 sm:w-28 sm:h-28 mx-auto rounded-full object-cover mb-3">` 
                                : ''
                            }
                            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-display font-bold" style="color: ${business.primary_color}">${business.name}</h1>
                            ${business.description ? `<p class="text-sm sm:text-base text-gray-600 mt-2">${business.description}</p>` : ''}
                        </div>
                        <h2 class="text-white text-xl sm:text-2xl lg:text-3xl font-display font-bold mb-2">¬°Bienvenido!</h2>
                        <p class="text-white text-base sm:text-lg lg:text-xl font-medium opacity-90">Ordena tu comida favorita</p>
                    </div>
                    
                    <button 
                        onclick="startOrder()"
                        class="btn-primary text-white text-base sm:text-lg lg:text-xl font-display font-bold py-4 sm:py-5 lg:py-6 px-6 sm:px-10 lg:px-12 rounded-xl lg:rounded-2xl transform hover:scale-105 w-full max-w-md">
                        <div class="flex items-center justify-center gap-3">
                            <span class="text-2xl sm:text-3xl">üëÜ</span>
                            <span>Toca para empezar</span>
                        </div>
                    </button>

                    <div class="mt-6 sm:mt-10 text-white text-center opacity-90">
                        <p class="text-xs sm:text-sm mb-1">‚ö° Powered by <strong>Somar Totem</strong></p>
                        <p class="text-xs opacity-75">Part of <strong>Somar Ecosystem</strong> üá≠üá≥</p>
                    </div>
                </div>
            `;
        }

        function MenuScreen() {
            const cartCount = getCartItemCount();
            const cartTotal = getCartTotal();
            const business = state.business;
            
            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <!-- Header fijo -->
                    <div class="flex-shrink-0 text-white px-3 sm:px-4 py-2 sm:py-3 shadow-lg" style="background: linear-gradient(135deg, ${business.primary_color} 0%, ${business.primary_color}dd 100%)">
                        <div class="flex items-center justify-between max-w-7xl mx-auto">
                            <div class="flex-1">
                                <h1 class="text-base sm:text-lg lg:text-xl font-display font-bold truncate">${business.name}</h1>
                                <p class="text-white opacity-75 text-xs sm:text-sm">Selecciona tus productos</p>
                            </div>
                            <button 
                                onclick="viewCart()"
                                class="bg-green-500 hover:bg-green-600 px-3 sm:px-4 lg:px-6 py-2 sm:py-2.5 rounded-lg lg:rounded-xl font-bold text-sm sm:text-base relative shadow-lg flex items-center gap-2">
                                üõí <span class="hidden xs:inline">Carrito</span>
                                ${cartCount > 0 ? `<span class="cart-badge absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center text-xs sm:text-sm font-bold shadow-lg">${cartCount}</span>` : ''}
                            </button>
                        </div>
                    </div>

                    <!-- Categor√≠as fijas -->
                    <div class="flex-shrink-0 bg-white shadow-md px-3 sm:px-4 py-2 overflow-x-auto">
                        <div class="flex gap-2 justify-start sm:justify-center max-w-7xl mx-auto">
                            ${state.categories.map(cat => `
                                <button 
                                    onclick="changeCategory('${cat.id}')"
                                    class="${state.activeCategory === cat.id ? 'tab-active' : 'tab-inactive'} px-3 sm:px-4 lg:px-6 py-2 rounded-lg lg:rounded-xl font-bold text-xs sm:text-sm lg:text-base transition-all flex-shrink-0 whitespace-nowrap">
                                    <span class="text-base sm:text-lg mr-1">${cat.icon}</span>
                                    <span>${cat.name}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Grid de Productos - SCROLLABLE -->
                    <div class="flex-1 overflow-y-auto scrollable-content px-3 sm:px-4 py-3 sm:py-4">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 sm:gap-3 lg:gap-4 max-w-7xl mx-auto">
                            ${getProductsByCategory(state.activeCategory).map(product => `
                                <div class="product-card bg-white rounded-lg lg:rounded-xl shadow-lg overflow-hidden border-2 border-gray-100 hover:border-green-500">
                                    ${product.image_url ? 
                                        `<img src="${product.image_url}" alt="${product.name}" class="w-full h-24 sm:h-32 object-cover">` :
                                        `<div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 sm:p-4 flex items-center justify-center h-20 sm:h-24 lg:h-28">
                                            <span class="text-3xl sm:text-4xl lg:text-5xl">${product.icon}</span>
                                        </div>`
                                    }
                                    <div class="p-2 sm:p-3">
                                        <h3 class="font-display font-bold text-xs sm:text-sm lg:text-base text-gray-800 mb-1 sm:mb-2 h-8 sm:h-10 flex items-center line-clamp-2">${product.name}</h3>
                                        <div class="flex flex-col gap-1.5">
                                            <p class="text-base sm:text-lg lg:text-xl font-bold text-green-600">L ${product.price.toFixed(2)}</p>
                                            <button 
                                                onclick='addToCart(${JSON.stringify(product).replace(/'/g, "\\'")})'
                                                class="btn-primary text-white px-2 py-1.5 sm:py-2 rounded-md lg:rounded-lg font-bold text-xs sm:text-sm w-full">
                                                + Agregar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Footer fijo con Total -->
                    ${cartCount > 0 ? `
                        <div class="flex-shrink-0 bg-white border-t-2 border-green-500 px-3 sm:px-4 py-2.5 sm:py-3 shadow-lg">
                            <div class="flex items-center justify-between max-w-7xl mx-auto gap-3">
                                <div class="flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm">Total:</p>
                                    <p class="text-xl sm:text-2xl font-display font-bold text-green-600">L ${cartTotal.toFixed(2)}</p>
                                </div>
                                <button 
                                    onclick="viewCart()"
                                    class="btn-primary text-white px-4 sm:px-6 lg:px-8 py-2.5 sm:py-3 rounded-lg lg:rounded-xl font-display font-bold text-sm sm:text-base lg:text-lg">
                                    Continuar ‚Üí
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function CartScreen() {
            const cartTotal = getCartTotal();
            const business = state.business;
            
            if (state.cart.length === 0) {
                return `
                    <div class="h-full flex flex-col items-center justify-center bg-gray-50 px-4">
                        <div class="text-center">
                            <p class="text-4xl sm:text-5xl mb-4">üõí</p>
                            <h2 class="text-xl sm:text-2xl font-display font-bold text-gray-700 mb-3">Tu carrito est√° vac√≠o</h2>
                            <button 
                                onclick="backToMenu()"
                                class="btn-primary text-white px-6 sm:px-8 py-3 sm:py-4 rounded-lg lg:rounded-xl font-bold text-base sm:text-lg mt-4">
                                ‚Üê Volver al Men√∫
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <!-- Header fijo -->
                    <div class="flex-shrink-0 text-white px-3 sm:px-4 py-2 sm:py-3 shadow-lg" style="background: linear-gradient(135deg, ${business.primary_color} 0%, ${business.primary_color}dd 100%)">
                        <div class="flex items-center justify-between max-w-5xl mx-auto">
                            <button 
                                onclick="backToMenu()"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 sm:px-4 py-2 rounded-lg font-bold text-sm sm:text-base">
                                ‚Üê Volver
                            </button>
                            <h1 class="text-base sm:text-lg lg:text-xl font-display font-bold">Tu Pedido</h1>
                            <div class="w-16 sm:w-20"></div>
                        </div>
                    </div>

                    <!-- Items - SCROLLABLE -->
                    <div class="flex-1 overflow-y-auto scrollable-content px-3 sm:px-4 py-3 sm:py-4">
                        <div class="space-y-2 max-w-4xl mx-auto">
                            ${state.cart.map(item => `
                                <div class="bg-white rounded-lg lg:rounded-xl shadow-lg p-3 sm:p-4 slide-in border border-gray-100">
                                    <div class="flex items-center justify-between gap-3">
                                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                            ${item.image_url ? 
                                                `<img src="${item.image_url}" alt="${item.name}" class="w-12 h-12 sm:w-16 sm:h-16 rounded-lg object-cover flex-shrink-0">` :
                                                `<span class="text-2xl sm:text-3xl flex-shrink-0">${item.icon}</span>`
                                            }
                                            <div class="min-w-0 flex-1">
                                                <h3 class="font-display font-bold text-sm sm:text-base text-gray-800 truncate">${item.name}</h3>
                                                <p class="text-xs sm:text-sm text-green-600 font-bold">L ${item.price.toFixed(2)} c/u</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
                                            <button 
                                                onclick="updateQuantity('${item.id}', -1)"
                                                class="quantity-btn bg-red-500 hover:bg-red-600 text-white w-7 h-7 sm:w-9 sm:h-9 rounded-lg font-bold text-lg sm:text-xl flex items-center justify-center">
                                                ‚àí
                                            </button>
                                            <span class="text-base sm:text-lg font-bold text-gray-800 w-6 sm:w-8 text-center">${item.quantity}</span>
                                            <button 
                                                onclick="updateQuantity('${item.id}', 1)"
                                                class="quantity-btn bg-green-500 hover:bg-green-600 text-white w-7 h-7 sm:w-9 sm:h-9 rounded-lg font-bold text-lg sm:text-xl flex items-center justify-center">
                                                +
                                            </button>
                                            <p class="text-sm sm:text-base font-bold text-gray-800 ml-1 sm:ml-2 w-14 sm:w-20 text-right">L ${(item.price * item.quantity).toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Footer fijo -->
                    <div class="flex-shrink-0 bg-white border-t-2 border-green-500 px-3 sm:px-4 py-3 sm:py-4 shadow-lg">
                        <div class="flex items-center justify-between max-w-4xl mx-auto gap-3">
                            <div class="flex-1">
                                <p class="text-gray-600 text-xs sm:text-sm">Total a pagar:</p>
                                <p class="text-2xl sm:text-3xl font-display font-bold text-green-600">L ${cartTotal.toFixed(2)}</p>
                            </div>
                            <button 
                                onclick="proceedToCheckout()"
                                class="btn-primary text-white px-6 sm:px-8 lg:px-10 py-3 sm:py-4 rounded-lg lg:rounded-xl font-display font-bold text-base sm:text-lg lg:text-xl">
                                Confirmar ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function CheckoutScreen() {
            const cartTotal = getCartTotal();
            const business = state.business;
            
            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <!-- Header fijo -->
                    <div class="flex-shrink-0 text-white px-3 sm:px-4 py-2 shadow-lg" style="background: linear-gradient(135deg, ${business.primary_color} 0%, ${business.primary_color}dd 100%)">
                        <div class="flex items-center justify-between max-w-4xl mx-auto">
                            <button 
                                onclick="backToCart()"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg font-bold text-sm">
                                ‚Üê Volver
                            </button>
                            <h1 class="text-base sm:text-lg font-display font-bold">Finalizar</h1>
                            <div class="w-16"></div>
                        </div>
                    </div>

                    <!-- Formulario - SCROLLABLE -->
                    <div class="flex-1 overflow-y-auto scrollable-content px-3 sm:px-4 py-3">
                        <div class="max-w-3xl mx-auto">
                            <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4">
                                <!-- Datos del Cliente -->
                                <div class="space-y-2.5 mb-3">
                                    <div>
                                        <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Nombre completo *</label>
                                        <input 
                                            type="text"
                                            id="customerName"
                                            value="${state.customerName}"
                                            placeholder="Ej: Juan P√©rez"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm sm:text-base focus:border-green-500 transition"
                                            required>
                                    </div>

                                    <div>
                                        <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1">Celular *</label>
                                        <input 
                                            type="tel"
                                            id="customerPhone"
                                            value="${state.customerPhone}"
                                            placeholder="Ej: 9999-9999"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm sm:text-base focus:border-green-500 transition"
                                            required>
                                    </div>
                                </div>

                                <!-- Selecci√≥n de Billete -->
                                <div class="border-t pt-3">
                                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-2">üí∞ ¬øCon cu√°nto pagar√°s?</label>
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        ${CONFIG.BILL_OPTIONS.map(amount => `
                                            <button 
                                                type="button"
                                                onclick="selectBill(${amount})"
                                                class="bill-option ${state.selectedBill === amount ? 'bill-selected' : 'bg-gray-100 hover:bg-gray-200 border-2 border-gray-300'} py-2.5 rounded-lg font-bold text-base sm:text-lg">
                                                L ${amount}
                                            </button>
                                        `).join('')}
                                    </div>
                                    
                                    <!-- Monto manual -->
                                    <div class="mb-2">
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">O ingresa otro monto:</label>
                                        <input 
                                            type="number"
                                            id="customBillAmount"
                                            placeholder="Ej: 150"
                                            min="${cartTotal}"
                                            step="1"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm sm:text-base focus:border-green-500"
                                            onchange="selectCustomBill(this.value)">
                                    </div>
                                    
                                    ${state.selectedBill && state.selectedBill < cartTotal ? `
                                        <p class="text-red-600 font-bold text-xs sm:text-sm">‚ö†Ô∏è Monto menor al total</p>
                                    ` : ''}
                                    ${state.selectedBill && state.selectedBill >= cartTotal ? `
                                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-2">
                                            <p class="text-green-700 font-bold text-xs sm:text-sm">‚úì Cambio: <span class="text-base sm:text-lg">L ${(state.selectedBill - cartTotal).toFixed(2)}</span></p>
                                        </div>
                                    ` : ''}
                                </div>

                                ${business.points_enabled ? `
                                    <div class="bg-blue-50 border border-blue-300 rounded-lg p-2 text-center mt-2">
                                        <p class="text-blue-800 font-bold text-xs sm:text-sm">üéÅ Ganar√°s ${Math.floor(cartTotal / business.points_ratio)} puntos</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Footer fijo -->
                    <div class="flex-shrink-0 bg-white border-t-2 border-green-500 px-3 sm:px-4 py-2.5 sm:py-3 shadow-lg">
                        <div class="flex items-center justify-between max-w-3xl mx-auto gap-2">
                            <div class="flex-1">
                                <p class="text-gray-600 text-xs">Total:</p>
                                <p class="text-xl sm:text-2xl font-display font-bold text-green-600">L ${cartTotal.toFixed(2)}</p>
                            </div>
                            <button 
                                onclick="confirmOrder()"
                                ${!state.customerName || !state.customerPhone || !state.selectedBill || state.selectedBill < cartTotal ? 'disabled' : ''}
                                class="${!state.customerName || !state.customerPhone || !state.selectedBill || state.selectedBill < cartTotal ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'btn-primary'} text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-lg font-display font-bold text-sm sm:text-base">
                                ‚úì Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function ConfirmationScreen() {
            const cartTotal = getCartTotal();
            const change = state.selectedBill - cartTotal;
            const business = state.business;
            const pointsEarned = business.points_enabled ? Math.floor(cartTotal / business.points_ratio) : 0;
            
            return `
                <div class="h-full flex items-center justify-center bg-gradient-to-br from-green-500 to-green-600 px-3 sm:px-4 py-3 fade-in overflow-y-auto scrollable-content">
                    <div class="w-full max-w-3xl my-auto">
                        <div class="bg-white rounded-xl shadow-2xl p-3 sm:p-4">
                            <!-- Header -->
                            <div class="text-center mb-3">
                                <div class="text-3xl sm:text-4xl mb-1">‚úÖ</div>
                                <h1 class="text-xl sm:text-2xl font-display font-bold text-gray-800">¬°Pedido Confirmado!</h1>
                                <p class="text-sm sm:text-base text-gray-600">Gracias, ${state.customerName}</p>
                            </div>
                            
                            <!-- Contenido -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <!-- N√∫mero -->
                                <div class="bg-blue-50 rounded-lg p-3 border-2 border-blue-200 text-center">
                                    <p class="text-xs sm:text-sm text-gray-600 mb-1">Tu n√∫mero:</p>
                                    <p class="text-4xl sm:text-5xl font-display font-bold text-blue-900">#${state.orderNumber}</p>
                                </div>

                                <!-- Detalles -->
                                <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">Total:</span>
                                        <span class="font-bold">L ${cartTotal.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between text-xs sm:text-sm">
                                        <span class="text-gray-600">Pagas:</span>
                                        <span class="font-bold text-blue-600">L ${state.selectedBill.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t">
                                        <span class="text-sm font-bold">Cambio:</span>
                                        <span class="text-lg sm:text-xl font-bold text-green-600">L ${change.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>

                            ${pointsEarned > 0 ? `
                                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-2 text-center mb-3">
                                    <p class="text-sm sm:text-base font-bold text-yellow-800">üéâ Ganaste ${pointsEarned} puntos</p>
                                </div>
                            ` : ''}

                            <!-- Footer -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
                                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-2 text-center">
                                    <p class="text-sm font-bold text-yellow-800">üìç Pasa a caja</p>
                                </div>
                                
                                <button 
                                    onclick="resetApp()"
                                    class="btn-secondary text-white px-4 py-2.5 sm:py-3 rounded-lg font-display font-bold text-sm sm:text-base w-full">
                                    ‚Üê Inicio
                                </button>
                            </div>

                            <div class="mt-3 pt-2 border-t text-center">
                                <p class="text-xs text-gray-400">‚ö° <strong>Somar Totem</strong> ‚Ä¢ <strong>Somar Ecosystem</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== FUNCIONES DE NAVEGACI√ìN ====================
        function startOrder() {
            state.screen = 'menu';
            render();
        }

        function changeCategory(categoryId) {
            state.activeCategory = categoryId;
            render();
        }

        function viewCart() {
            state.screen = 'cart';
            render();
        }

        function backToMenu() {
            state.screen = 'menu';
            render();
        }

        function backToCart() {
            state.screen = 'cart';
            render();
        }

        function proceedToCheckout() {
            state.screen = 'checkout';
            render();
        }

        function selectBill(amount) {
            state.selectedBill = amount;
            const customInput = document.getElementById('customBillAmount');
            if (customInput) customInput.value = '';
            render();
        }

        function selectCustomBill(amount) {
            const numAmount = parseFloat(amount);
            if (numAmount && numAmount > 0) {
                state.selectedBill = numAmount;
                render();
            }
        }

        async function confirmOrder() {
            const nameInput = document.getElementById('customerName');
            const phoneInput = document.getElementById('customerPhone');
            
            if (nameInput) state.customerName = nameInput.value;
            if (phoneInput) state.customerPhone = phoneInput.value;
            
            if (!state.customerName || !state.customerPhone || !state.selectedBill) {
                alert('Por favor completa todos los campos');
                return;
            }

            if (state.selectedBill < getCartTotal()) {
                alert('El monto seleccionado es insuficiente');
                return;
            }

            await createOrder();
        }

        // ==================== RENDERIZADO ====================
        function render() {
            const app = document.getElementById('app');
            
            let content = '';
            switch(state.screen) {
                case 'loading':
                    content = LoadingScreen();
                    break;
                case 'error':
                    content = ErrorScreen();
                    break;
                case 'closed':
                    content = ClosedScreen();
                    break;
                case 'welcome':
                    content = WelcomeScreen();
                    break;
                case 'menu':
                    content = MenuScreen();
                    break;
                case 'cart':
                    content = CartScreen();
                    break;
                case 'checkout':
                    content = CheckoutScreen();
                    break;
                case 'confirmation':
                    content = ConfirmationScreen();
                    break;
                default:
                    content = LoadingScreen();
            }
            
            app.innerHTML = content;
        }

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadBusinessData();
        });

        // Prevenir zoom con pellizco
        document.addEventListener('touchmove', function(event) {
            if (event.scale !== undefined && event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Recargar datos cada 5 minutos
        setInterval(() => {
            if (state.screen === 'welcome' || state.screen === 'closed') {
                loadBusinessData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
