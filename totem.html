<!DOCTYPE HTML>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Somar Totem - Autoservicio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35); }
        .tab-active { background: linear-gradient(135deg, var(--primary-color, #1e3a8a) 0%, #1e40af 100%); color: white; }
        .loading-spinner { border: 4px solid #f3f4f6; border-top: 4px solid var(--primary-color, #1e3a8a); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .welcome-bg { background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.9) 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // 1. CONFIGURACI√ìN
        const CONFIG = {
            SUPABASE_URL: 'https://osmghhkskiqrzxnbnsyf.supabase.co',
            SUPABASE_ANON_KEY: 'sb_publishable_KFNd_uM0YM2y6x5tWBWr-Q_Oi5NofzM', // Aseg√∫rate que esta sea tu ANON KEY real
            BUSINESS_SLUG: 'demo-restaurant',
            BILL_OPTIONS: [50, 100, 200, 500]
        };

        // 2. INICIALIZACI√ìN (Nombre cambiado para evitar conflictos)
        const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // 3. ESTADO
        let state = {
            screen: 'loading',
            business: null,
            categories: [],
            products: [],
            activeCategory: null,
            cart: [],
            customerName: '',
            customerPhone: '',
            selectedBill: null,
            orderNumber: null,
            isOpen: false,
            error: null
        };

        // 4. FUNCIONES DE DATOS
        async function loadBusinessData() {
            try {
                const { data, error } = await supabaseClient.rpc('get_business_data', {
                    business_slug: CONFIG.BUSINESS_SLUG
                });

                if (error) throw error;
                state.business = data.business;
                state.categories = data.categories || [];
                state.products = data.products || [];
                state.isOpen = data.is_open;
                state.activeCategory = state.categories[0]?.id || null;

                document.documentElement.style.setProperty('--primary-color', state.business.primary_color);
                state.screen = state.isOpen ? 'welcome' : 'closed';
            } catch (e) {
                state.error = e.message;
                state.screen = 'error';
            } finally {
                render();
            }
        }

        async function createOrder() {
            try {
                let customerId = null;
                if (state.customerPhone) {
                    const { data: cust } = await supabaseClient.from('customers').select('id').eq('phone', state.customerPhone).maybeSingle();
                    if (cust) {
                        customerId = cust.id;
                    } else {
                        const { data: newCust } = await supabaseClient.from('customers').insert({ phone: state.customerPhone, name: state.customerName }).select().single();
                        customerId = newCust.id;
                    }
                }

                const total = getCartTotal();
                const { data: order, error } = await supabaseClient.from('orders').insert({
                    business_id: state.business.id,
                    customer_id: customerId,
                    items: state.cart,
                    subtotal: total,
                    total: total,
                    payment_method: 'cash',
                    payment_amount: state.selectedBill,
                    change_amount: state.selectedBill - total,
                    status: 'pending'
                }).select().single();

                if (error) throw error;
                state.orderNumber = order.order_number;
                state.screen = 'confirmation';
            } catch (e) {
                alert('Error al crear orden: ' + e.message);
            } finally {
                render();
            }
        }

        // 5. UTILIDADES
        const getCartTotal = () => state.cart.reduce((s, i) => s + (i.price * i.quantity), 0);
        const getCartCount = () => state.cart.reduce((s, i) => s + i.quantity, 0);

        function addToCart(product) {
            const item = state.cart.find(i => i.id === product.id);
            item ? item.quantity++ : state.cart.push({...product, quantity: 1});
            render();
        }

        function updateQuantity(id, change) {
            const item = state.cart.find(i => i.id === id);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) state.cart = state.cart.filter(i => i.id !== id);
            }
            render();
        }

        function selectBill(amt) { state.selectedBill = amt; render(); }
        function resetApp() { location.reload(); }

        // 6. COMPONENTES (Vistas)
        function LoadingScreen() { return `<div class="h-screen flex items-center justify-center bg-blue-900 text-white text-2xl"><div class="loading-spinner mr-4"></div> Cargando...</div>`; }
        
        function ClosedScreen() { return `<div class="h-screen flex flex-col items-center justify-center bg-black text-white p-8 text-center"><h1 class="text-5xl mb-4">üïí Cerrado</h1><p class="text-xl">Estamos fuera de horario.</p><button onclick="location.reload()" class="mt-8 bg-white text-black px-6 py-3 rounded">Actualizar</button></div>`; }

        function WelcomeScreen() {
            return `
                <div class="welcome-bg h-screen flex flex-col items-center justify-center text-white p-6">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl mb-8 text-center text-black">
                        <h1 class="text-4xl font-bold" style="color:${state.business.primary_color}">${state.business.name}</h1>
                        <p class="text-gray-500 mt-2">${state.business.description || ''}</p>
                    </div>
                    <button onclick="state.screen='menu';render()" class="btn-primary px-12 py-8 rounded-3xl text-3xl font-bold transform active:scale-95 transition">
                        üëÜ Toca para Ordenar
                    </button>
                </div>`;
        }

        function MenuScreen() {
            const prods = state.products.filter(p => p.category_id === state.activeCategory);
            return `
                <div class="h-screen flex flex-col">
                    <header class="p-4 text-white flex justify-between items-center shadow-lg" style="background:${state.business.primary_color}">
                        <h1 class="text-2xl font-bold">${state.business.name}</h1>
                        <button onclick="state.screen='cart';render()" class="bg-green-500 p-4 rounded-2xl font-bold relative">
                            üõí Carrito (${getCartCount()})
                        </button>
                    </header>
                    <nav class="flex gap-2 p-4 overflow-x-auto bg-white border-b">
                        ${state.categories.map(c => `
                            <button onclick="state.activeCategory='${c.id}';render()" class="px-6 py-3 rounded-xl font-bold whitespace-nowrap ${state.activeCategory===c.id ? 'tab-active' : 'bg-gray-100'}">
                                ${c.icon} ${c.name}
                            </button>
                        `).join('')}
                    </nav>
                    <main class="flex-1 overflow-y-auto p-6 grid grid-cols-2 md:grid-cols-4 gap-6">
                        ${prods.map(p => `
                            <div class="bg-white p-4 rounded-2xl shadow-xl border-2 border-gray-100 flex flex-col justify-between">
                                <div class="text-center text-6xl mb-4">${p.icon}</div>
                                <h3 class="font-bold text-lg">${p.name}</h3>
                                <p class="text-green-600 font-bold text-2xl my-2">L ${p.price}</p>
                                <button onclick='addToCart(${JSON.stringify(p)})' class="btn-primary py-3 rounded-xl text-white font-bold">+ Agregar</button>
                            </div>
                        `).join('')}
                    </main>
                    ${getCartCount() > 0 ? `
                        <footer class="p-6 bg-white border-t-4 border-green-500 flex justify-between items-center shadow-2xl">
                            <div><p class="text-gray-500">Total:</p><p class="text-3xl font-bold text-green-600">L ${getCartTotal().toFixed(2)}</p></div>
                            <button onclick="state.screen='cart';render()" class="btn-primary px-12 py-5 rounded-2xl text-white font-bold text-xl">Revisar Pedido ‚Üí</button>
                        </footer>
                    ` : ''}
                </div>`;
        }

        function CartScreen() {
            return `
                <div class="h-screen flex flex-col bg-gray-50 p-6">
                    <header class="flex justify-between items-center mb-6">
                        <button onclick="state.screen='menu';render()" class="bg-gray-200 px-6 py-3 rounded-xl font-bold">‚Üê Volver</button>
                        <h1 class="text-3xl font-bold">Tu Pedido</h1>
                        <div class="w-20"></div>
                    </header>
                    <div class="flex-1 overflow-y-auto space-y-4">
                        ${state.cart.map(i => `
                            <div class="bg-white p-4 rounded-2xl shadow flex justify-between items-center">
                                <div><h3 class="font-bold text-xl">${i.name}</h3><p class="text-green-600 font-bold">L ${i.price}</p></div>
                                <div class="flex items-center gap-4">
                                    <button onclick="updateQuantity('${i.id}',-1)" class="bg-red-500 text-white w-10 h-10 rounded-full font-bold">-</button>
                                    <span class="text-2xl font-bold">${i.quantity}</span>
                                    <button onclick="updateQuantity('${i.id}',1)" class="bg-green-500 text-white w-10 h-10 rounded-full font-bold">+</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="state.screen='checkout';render()" class="btn-primary w-full py-6 mt-6 rounded-2xl text-white text-2xl font-bold">Pagar L ${getCartTotal().toFixed(2)}</button>
                </div>`;
        }

        function CheckoutScreen() {
            const total = getCartTotal();
            return `
                <div class="h-screen flex flex-col p-6 bg-gray-50">
                    <header class="flex justify-between mb-8"><button onclick="state.screen='cart';render()" class="bg-gray-200 px-6 py-3 rounded-xl font-bold">‚Üê Atr√°s</button><h1 class="text-3xl font-bold">Finalizar</h1><div class="w-20"></div></header>
                    <div class="max-w-2xl mx-auto w-full bg-white p-8 rounded-3xl shadow-2xl space-y-6">
                        <input id="cName" type="text" placeholder="Tu Nombre" class="w-full p-4 border-2 rounded-xl text-xl" oninput="state.customerName=this.value">
                        <input id="cPhone" type="tel" placeholder="Tu Tel√©fono" class="w-full p-4 border-2 rounded-xl text-xl" oninput="state.customerPhone=this.value">
                        <div class="grid grid-cols-2 gap-4">
                            ${CONFIG.BILL_OPTIONS.map(b => `<button onclick="selectBill(${b})" class="p-4 rounded-xl font-bold text-xl ${state.selectedBill===b?'bill-selected':'bg-gray-100'}">L ${b}</button>`).join('')}
                        </div>
                        <button onclick="createOrder()" class="btn-primary w-full py-6 rounded-2xl text-white text-2xl font-bold">Confirmar Pedido</button>
                    </div>
                </div>`;
        }

        function ConfirmationScreen() {
            return `
                <div class="h-screen flex flex-col items-center justify-center bg-green-500 text-white p-10 text-center">
                    <h1 class="text-6xl font-bold mb-4">¬°Listo!</h1>
                    <p class="text-2xl mb-8">Tu n√∫mero de orden es:</p>
                    <div class="bg-white text-green-600 text-9xl font-black p-10 rounded-full shadow-2xl mb-10">#${state.orderNumber}</div>
                    <p class="text-xl mb-10">Pasa a caja para pagar L ${getCartTotal().toFixed(2)}</p>
                    <button onclick="resetApp()" class="bg-white text-green-600 px-12 py-5 rounded-2xl font-bold text-2xl">Finalizar</button>
                </div>`;
        }

        // 7. RENDERIZADO FINAL
        function render() {
            const app = document.getElementById('app');
            const screens = {
                loading: LoadingScreen,
                closed: ClosedScreen,
                welcome: WelcomeScreen,
                menu: MenuScreen,
                cart: CartScreen,
                checkout: CheckoutScreen,
                confirmation: ConfirmationScreen,
                error: () => `<div class="p-10 text-center"><h1>Error</h1><p>${state.error}</p></div>`
            };
            app.innerHTML = (screens[state.screen] || screens.loading)();
        }

        document.addEventListener('DOMContentLoaded', loadBusinessData);
    </script>
</body>
</html>
