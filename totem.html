<!DOCTYPE HTML>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="screen-orientation" content="landscape">
    <title>Somar Totem - Autoservicio</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '475px',
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        h1, h2, h3, .font-display {
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
            transition: all 0.2s ease;
        }

        .btn-primary:active {
            transform: scale(0.96);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--primary-color, #1e3a8a) 0%, var(--primary-dark, #1e40af) 100%);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.3);
            transition: all 0.2s ease;
        }

        .btn-secondary:active {
            transform: scale(0.96);
        }

        .product-card {
            transition: all 0.25s ease;
            cursor: pointer;
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .tab-active {
            background: linear-gradient(135deg, var(--primary-color, #1e3a8a) 0%, var(--primary-dark, #1e40af) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(30, 58, 138, 0.4);
        }

        .tab-inactive {
            background: white;
            color: var(--primary-color, #1e3a8a);
            border: 2px solid #e5e7eb;
        }

        .cart-badge {
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .welcome-bg {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.9) 100%),
                        url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect fill="%231e3a8a" width="100" height="100"/><circle cx="50" cy="50" r="40" fill="%231e40af" opacity="0.1"/></svg>');
            background-size: cover, 100px 100px;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color, #1e3a8a);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quantity-btn {
            transition: all 0.15s ease;
        }

        .quantity-btn:active {
            transform: scale(0.9);
        }

        .bill-option {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .bill-option:active {
            transform: scale(0.96);
        }

        .bill-selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .closed-overlay {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }

        /* Fix para h-screen en m√≥viles */
        @supports (-webkit-touch-callout: none) {
            .h-screen {
                min-height: -webkit-fill-available;
            }
        }

        /* Permitir scroll en contenedores flex-1 */
        .overflow-y-auto {
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }

        /* Asegurar que los padres permitan scroll */
        .flex-1 {
            flex: 1 1 0%;
            min-height: 0;
        }

        /* Mejor scroll en webkit */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Scroll m√°s suave en iOS */
        * {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Loading inicial -->
        <div class="h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-xl">Cargando Somar Totem...</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const CONFIG = {
            SUPABASE_URL: 'https://osmghhkskiqrzxnbnsyf.supabase.co',  // Reemplazar
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zbWdoaGtza2lxcnp4bmJuc3lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjM0MTgsImV4cCI6MjA4NDY5OTQxOH0.6Ikhw3xTiAs2lAKy_7WpeZLPJ4V0az_FZ7ETWUrKEjo',  // Reemplazar
            BUSINESS_SLUG: 'demo-restaurant',  // Slug fijo del negocio
            BILL_OPTIONS: [50, 100, 200, 500]
        };

        // Inicializar Supabase
        const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // ==================== ESTADO DE LA APLICACI√ìN ====================
        let state = {
            screen: 'loading', // loading, closed, welcome, menu, cart, checkout, confirmation
            business: null,
            categories: [],
            products: [],
            activeCategory: null,
            cart: [],
            customerName: '',
            customerPhone: '',
            selectedBill: null,
            orderNumber: null,
            isOpen: false,
            loading: true,
            error: null
        };

        // ==================== FUNCIONES DE SUPABASE ====================
        async function loadBusinessData() {
            try {
                state.loading = true;
                state.error = null;
                
                // Llamar a la funci√≥n RPC que obtiene todos los datos
                const { data, error } = await supabaseClient.rpc('get_business_data', {
                    business_slug: CONFIG.BUSINESS_SLUG
                });

                if (error) throw error;
                if (!data) throw new Error('Negocio no encontrado');

                // Actualizar estado
                state.business = data.business;
                state.categories = data.categories || [];
                state.products = data.products || [];
                state.isOpen = data.is_open;
                state.activeCategory = state.categories[0]?.id || null;

                // Aplicar colores del negocio
                document.documentElement.style.setProperty('--primary-color', state.business.primary_color);
                document.documentElement.style.setProperty('--accent-color', state.business.accent_color);

                state.loading = false;
                state.screen = state.isOpen ? 'welcome' : 'closed';
                
            } catch (error) {
                console.error('Error loading business:', error);
                state.error = error.message;
                state.loading = false;
                state.screen = 'error';
            } finally {
                render();
            }
        }

        async function createOrder() {
            try {
                // Buscar o crear cliente
                let customerId = null;
                
                if (state.customerPhone) {
                    // Buscar cliente existente
                    let { data: existingCustomer } = await supabaseClient
                        .from('customers')
                        .select('*')
                        .eq('phone', state.customerPhone)
                        .single();

                    if (existingCustomer) {
                        customerId = existingCustomer.id;
                    } else {
                        // Crear nuevo cliente
                        const { data: newCustomer, error } = await supabaseClient
                            .from('customers')
                            .insert({
                                phone: state.customerPhone,
                                name: state.customerName
                            })
                            .select()
                            .single();

                        if (error) throw error;
                        customerId = newCustomer.id;
                    }
                }

                // Calcular puntos si est√° habilitado
                const total = getCartTotal();
                let pointsEarned = 0;
                
                if (state.business.points_enabled && customerId) {
                    pointsEarned = Math.floor(total / state.business.points_ratio);
                }

                // Crear orden
                const { data: order, error } = await supabaseClient
                    .from('orders')
                    .insert({
                        business_id: state.business.id,
                        customer_id: customerId,
                        items: state.cart,
                        subtotal: total,
                        total: total,
                        payment_method: 'cash',
                        payment_amount: state.selectedBill,
                        change_amount: state.selectedBill - total,
                        points_earned: pointsEarned,
                        status: 'pending'
                    })
                    .select()
                    .single();

                if (error) throw error;

                state.orderNumber = order.order_number;
                state.screen = 'confirmation';
                render();

            } catch (error) {
                console.error('Error creating order:', error);
                alert('Error al crear la orden. Por favor intenta nuevamente.');
            }
        }

        // ==================== FUNCIONES DE UTILIDAD ====================
        function getCartTotal() {
            return state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        function getCartItemCount() {
            return state.cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        function addToCart(product) {
            const existingItem = state.cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.cart.push({ ...product, quantity: 1 });
            }
            render();
        }

        function updateQuantity(productId, change) {
            const item = state.cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    state.cart = state.cart.filter(i => i.id !== productId);
                }
                render();
            }
        }

        function resetApp() {
            state = {
                ...state,
                screen: 'welcome',
                cart: [],
                customerName: '',
                customerPhone: '',
                selectedBill: null,
                orderNumber: null
            };
            render();
        }

        function getProductsByCategory(categoryId) {
            return state.products.filter(p => p.category_id === categoryId);
        }

        // ==================== COMPONENTES DE LA INTERFAZ ====================
        
        function LoadingScreen() {
            return `
                <div class="h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-800 fade-in">
                    <div class="text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-white text-xl sm:text-2xl">Cargando...</p>
                    </div>
                </div>
            `;
        }

        function ErrorScreen() {
            return `
                <div class="h-screen flex items-center justify-center bg-gradient-to-br from-red-900 to-red-800 px-4 fade-in">
                    <div class="text-center bg-white rounded-3xl p-8 max-w-2xl">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h1 class="text-3xl font-display font-bold text-gray-800 mb-4">Error</h1>
                        <p class="text-xl text-gray-600 mb-6">${state.error || 'No se pudo cargar el negocio'}</p>
                        <button onclick="location.reload()" class="btn-primary text-white px-8 py-4 rounded-2xl font-bold text-lg">
                            Reintentar
                        </button>
                    </div>
                </div>
            `;
        }

        function ClosedScreen() {
            const business = state.business;
            return `
                <div class="h-screen flex items-center justify-center closed-overlay px-4 fade-in">
                    <div class="text-center bg-white rounded-3xl p-8 max-w-2xl">
                        ${business.logo_url ? `<img src="${business.logo_url}" alt="${business.name}" class="w-32 h-32 mx-auto mb-4 rounded-full object-cover">` : ''}
                        <h1 class="text-4xl font-display font-bold text-gray-800 mb-4">${business.name}</h1>
                        <div class="text-7xl mb-6">üïí</div>
                        <h2 class="text-2xl font-display font-bold text-gray-700 mb-4">Estamos Cerrados</h2>
                        <p class="text-lg text-gray-600 mb-6">
                            Nuestro horario es:<br>
                            <strong>${business.opening_time} - ${business.closing_time}</strong>
                        </p>
                        <p class="text-base text-gray-500">¬°Vuelve pronto!</p>
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <p class="text-sm text-gray-400 flex items-center justify-center gap-2">
                                <span>‚ö°</span>
                                <span>Powered by <strong>Somar Totem</strong></span>
                                <span>‚Ä¢</span>
                                <span>Part of <strong>Somar Ecosystem</strong></span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function WelcomeScreen() {
            const business = state.business;
            return `
                <div class="welcome-bg h-screen flex flex-col items-center justify-center px-4 sm:px-6 lg:px-8 fade-in">
                    <div class="text-center mb-6 sm:mb-8 lg:mb-12">
                        <div class="bg-white rounded-2xl lg:rounded-3xl p-4 sm:p-6 lg:p-8 mb-4 sm:mb-6 lg:mb-8 inline-block shadow-2xl">
                            ${business.logo_url ? 
                                `<img src="${business.logo_url}" alt="${business.name}" class="w-24 h-24 sm:w-32 sm:h-32 lg:w-40 lg:h-40 mx-auto rounded-full object-cover mb-4">` 
                                : ''
                            }
                            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-display font-bold" style="color: ${business.primary_color}">${business.name}</h1>
                            ${business.description ? `<p class="text-base sm:text-lg text-gray-600 mt-2">${business.description}</p>` : ''}
                        </div>
                        <h2 class="text-white text-2xl sm:text-3xl lg:text-4xl font-display font-bold mb-2 sm:mb-3 lg:mb-4">¬°Bienvenido!</h2>
                        <p class="text-white text-lg sm:text-xl lg:text-2xl font-medium opacity-90">Ordena tu comida favorita</p>
                    </div>
                    
                    <button 
                        onclick="startOrder()"
                        class="btn-primary text-white text-lg sm:text-2xl lg:text-3xl font-display font-bold py-5 sm:py-6 lg:py-8 px-8 sm:px-12 lg:px-16 rounded-2xl lg:rounded-3xl transform hover:scale-105 w-full sm:w-auto max-w-2xl">
                        <div class="flex items-center justify-center gap-3 sm:gap-4">
                            <span class="text-3xl sm:text-4xl lg:text-5xl">üëÜ</span>
                            <span>Toca para empezar tu pedido</span>
                        </div>
                    </button>

                    <div class="mt-6 sm:mt-10 lg:mt-16 text-white text-center opacity-90">
                        <p class="text-xs sm:text-sm lg:text-base mb-2">‚ö° Powered by <strong>Somar Totem</strong></p>
                        <p class="text-xs sm:text-sm opacity-75">Part of <strong>Somar Ecosystem</strong> üá≠üá≥</p>
                    </div>
                </div>
            `;
        }

        function MenuScreen() {
            const cartCount = getCartItemCount();
            const cartTotal = getCartTotal();
            const business = state.business;
            
            return `
                <div class="h-screen flex flex-col bg-gray-50">
                    <!-- Header compacto -->
                    <div class="text-white px-4 sm:px-6 lg:px-8 py-3 sm:py-4 shadow-xl" style="background: linear-gradient(135deg, ${business.primary_color} 0%, ${business.primary_color}dd 100%)">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-xl sm:text-2xl lg:text-3xl font-display font-bold">${business.name}</h1>
                                <p class="text-white opacity-75 text-xs sm:text-sm mt-1">Selecciona tus productos</p>
                            </div>
                            <button 
                                onclick="viewCart()"
                                class="bg-green-500 hover:bg-green-600 px-4 sm:px-6 lg:px-8 py-2 sm:py-3 rounded-xl lg:rounded-2xl font-bold text-base sm:text-lg lg:text-xl relative shadow-lg transform hover:scale-105 transition">
                                üõí <span class="hidden sm:inline">Ver Carrito</span>
                                ${cartCount > 0 ? `<span class="cart-badge absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center text-sm sm:text-base lg:text-lg font-bold shadow-lg">${cartCount}</span>` : ''}
                            </button>
                        </div>
                    </div>

                    <!-- Categor√≠as -->
                    <div class="bg-white shadow-md px-4 sm:px-6 lg:px-8 py-2 sm:py-3 overflow-x-auto">
                        <div class="flex gap-2 sm:gap-3 justify-center">
                            ${state.categories.map(cat => `
                                <button 
                                    onclick="changeCategory('${cat.id}')"
                                    class="${state.activeCategory === cat.id ? 'tab-active' : 'tab-inactive'} px-4 sm:px-6 lg:px-8 py-2 sm:py-3 rounded-xl lg:rounded-2xl font-bold text-sm sm:text-base lg:text-lg transition-all transform hover:scale-105 flex-shrink-0">
                                    <span class="text-xl sm:text-2xl mr-1 sm:mr-2">${cat.icon}</span>
                                    <span class="hidden sm:inline">${cat.name}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Grid de Productos -->
                    <div class="flex-1 overflow-y-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4 lg:py-5">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-5 max-w-7xl mx-auto">
                            ${getProductsByCategory(state.activeCategory).map(product => `
                                <div class="product-card bg-white rounded-xl lg:rounded-2xl shadow-xl overflow-hidden border-2 sm:border-3 lg:border-4 border-gray-100 hover:border-green-500">
                                    ${product.image_url ? 
                                        `<img src="${product.image_url}" alt="${product.name}" class="w-full h-32 sm:h-40 object-cover">` :
                                        `<div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 sm:p-5 lg:p-6 flex items-center justify-center h-24 sm:h-28 lg:h-32">
                                            <span class="text-4xl sm:text-5xl lg:text-6xl">${product.icon}</span>
                                        </div>`
                                    }
                                    <div class="p-3 sm:p-4">
                                        <h3 class="font-display font-bold text-sm sm:text-base lg:text-lg text-gray-800 mb-2 h-10 sm:h-12 lg:h-14 flex items-center">${product.name}</h3>
                                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mt-2 sm:mt-3 gap-2">
                                            <p class="text-xl sm:text-xl lg:text-2xl font-bold text-green-600">L ${product.price.toFixed(2)}</p>
                                            <button 
                                                onclick='addToCart(${JSON.stringify(product).replace(/'/g, "\\'")})'
                                                class="btn-primary text-white px-3 sm:px-4 py-2 rounded-lg lg:rounded-xl font-bold text-xs sm:text-sm lg:text-base w-full sm:w-auto">
                                                + Agregar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Footer con Total -->
                    ${cartCount > 0 ? `
                        <div class="bg-white border-t-3 sm:border-t-4 border-green-500 px-4 sm:px-6 lg:px-8 py-3 sm:py-4 shadow-2xl">
                            <div class="flex flex-col sm:flex-row items-center justify-between max-w-7xl mx-auto gap-3 sm:gap-0">
                                <div class="text-center sm:text-left">
                                    <p class="text-gray-600 text-xs sm:text-sm lg:text-base">Total de tu pedido:</p>
                                    <p class="text-2xl sm:text-3xl font-display font-bold text-green-600">L ${cartTotal.toFixed(2)}</p>
                                </div>
                                <button 
                                    onclick="viewCart()"
                                    class="btn-primary text-white px-8 sm:px-10 lg:px-12 py-4 sm:py-5 rounded-xl lg:rounded-2xl font-display font-bold text-lg sm:text-xl lg:text-2xl w-full sm:w-auto">
                                    Continuar ‚Üí
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Continuar√° en la siguiente parte...
        // Por l√≠mite de espacio, las otras pantallas (Cart, Checkout, Confirmation) seguir√°n el mismo patr√≥n

        function CartScreen() {
            const cartTotal = getCartTotal();
            const business = state.business;
            
            if (state.cart.length === 0) {
                return `
                    <div class="h-screen flex flex-col items-center justify-center bg-gray-50 px-4">
                        <div class="text-center">
                            <p class="text-5xl sm:text-6xl lg:text-7xl mb-4 sm:mb-6">üõí</p>
                            <h2 class="text-2xl sm:text-3xl font-display font-bold text-gray-700 mb-4">Tu carrito est√° vac√≠o</h2>
                            <button 
                                onclick="backToMenu()"
                                class="btn-primary text-white px-8 sm:px-10 lg:px-12 py-4 sm:py-5 rounded-xl lg:rounded-2xl font-bold text-lg sm:text-xl mt-4 sm:mt-6">
                                ‚Üê Volver al Men√∫
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="h-screen flex flex-col bg-gray-50">
                    <!-- Header -->
                    <div class="text-white px-4 sm:px-6 lg:px-8 py-3 sm:py-4 shadow-xl" style="background: linear-gradient(135deg, ${business.primary_color} 0%, ${business.primary_color}dd 100%)">
                        <div class="flex items-center justify-between">
                            <button 
                                onclick="backToMenu()"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 sm:px-6 py-2 sm:py-3 rounded-xl font-bold text-base sm:text-lg transition">
                                ‚Üê Volver
                            </button>
                            <h1 class="text-xl sm:text-2xl lg:text-3xl font-display font-bold">Tu Pedido</h1>
                            <div class="w-16 sm:w-24 lg:w-32"></div>
                        </div>
                    </div>

                    <!-- Items -->
                    <div class="flex-1 overflow-y-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4 lg:py-5">
                        <div class="space-y-2 sm:space-y-3 max-w-6xl mx-auto">
                            ${state.cart.map(item => `
                                <div class="bg-white rounded-xl lg:rounded-2xl shadow-lg p-3 sm:p-4 lg:p-5 slide-in border-2 border-gray-100">
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4">
                                        <div class="flex items-center gap-3 sm:gap-4 lg:gap-6 flex-1 w-full sm:w-auto">
                                            ${item.image_url ? 
                                                `<img src="${item.image_url}" alt="${item.name}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg object-cover">` :
                                                `<span class="text-4xl sm:text-5xl">${item.icon}</span>`
                                            }
                                            <div>
                                                <h3 class="font-display font-bold text-base sm:text-lg lg:text-xl text-gray-800">${item.name}</h3>
                                                <p class="text-sm sm:text-base lg:text-lg text-green-600 font-bold mt-1">L ${item.price.toFixed(2)} c/u</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 sm:gap-3 lg:gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                            <button 
                                                onclick="updateQuantity('${item.id}', -1)"
                                                class="quantity-btn bg-red-500 hover:bg-red-600 text-white w-10 h-10 sm:w-12 sm:h-12 rounded-lg lg:rounded-xl font-bold text-xl sm:text-2xl flex items-center justify-center shadow-lg">
                                                ‚àí
                                            </button>
                                            <span class="text-xl sm:text-2xl font-bold text-gray-800 w-10 sm:w-12 lg:w-14 text-center">${item.quantity}</span>
                                            <button 
                                                onclick="updateQuantity('${item.id}', 1)"
                                                class="quantity-btn bg-green-500 hover:bg-green-600 text-white w-10 h-10 sm:w-12 sm:h-12 rounded-lg lg:rounded-xl font-bold text-xl sm:text-2xl flex items-center justify-center shadow-lg">
                                                +
                                            </button>
                                            <p class="text-xl sm:text-2xl font-bold text-gray-800 ml-2 sm:ml-4 w-20 sm:w-24 lg:w-28 text-right">L ${(item.price * item.quantity).toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-white border-t-3 sm:border-t-4 border-green-500 px-4 sm:px-6 lg:px-8 py-4 sm:py-5 shadow-2xl">
                        <div class="flex flex-col sm:flex-row items-center justify-between max-w-6xl mx-auto gap-3 sm:gap-0">
                            <div class="text-center sm:text-left">
                                <p class="text-gray-600 text-base sm:text-lg">Total a pagar:</p>
                                <p class="text-3xl sm:text-4xl font-display font-bold text-green-600">L ${cartTotal.toFixed(2)}</p>
                            </div>
                            <button 
                                onclick="proceedToCheckout()"
                                class="btn-primary text-white px-10 sm:px-12 lg:px-16 py-5 sm:py-6 rounded-xl lg:rounded-2xl font-display font-bold text-xl sm:text-2xl w-full sm:w-auto">
                                Confirmar Pedido ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function CheckoutScreen() {
            const cartTotal = getCartTotal();
            const business = state.business;
            
            return `
                <div class="min-h-screen flex flex-col bg-gray-50">
                    <!-- Header compacto -->
                    <div class="text-white px-3 py-2 shadow-xl" style="background: linear-gradient(135deg, ${business.primary_color} 0%, ${business.primary_color}dd 100%)">
                        <div class="flex items-center justify-between">
                            <button 
                                onclick="backToCart()"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg font-bold text-sm">
                                ‚Üê Volver
                            </button>
                            <h1 class="text-lg font-display font-bold">Finalizar Pedido</h1>
                            <div class="w-16"></div>
                        </div>
                    </div>

                    <!-- Formulario compacto con scroll -->
                    <div class="flex-1 overflow-y-auto px-3 py-3">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-xl shadow-lg p-3">
                                
                                <!-- Datos del Cliente -->
                                <div class="space-y-3 mb-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">Nombre completo *</label>
                                        <input 
                                            type="text"
                                            id="customerName"
                                            value="${state.customerName}"
                                            placeholder="Ej: Juan P√©rez"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-base focus:border-green-500 transition"
                                            required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">N√∫mero de celular *</label>
                                        <input 
                                            type="tel"
                                            id="customerPhone"
                                            value="${state.customerPhone}"
                                            placeholder="Ej: 9999-9999"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-base focus:border-green-500 transition"
                                            required>
                                    </div>
                                </div>

                                <!-- Selecci√≥n de Billete -->
                                <div class="border-t pt-3">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">üí∞ ¬øCon cu√°nto pagar√°s?</label>
                                    <div class="grid grid-cols-2 gap-2 mb-3">
                                        ${CONFIG.BILL_OPTIONS.map(amount => `
                                            <button 
                                                type="button"
                                                onclick="selectBill(${amount})"
                                                class="bill-option ${state.selectedBill === amount ? 'bill-selected' : 'bg-gray-100 hover:bg-gray-200 border-2 border-gray-300'} py-3 rounded-lg font-bold text-lg">
                                                L ${amount}
                                            </button>
                                        `).join('')}
                                    </div>
                                    
                                    <!-- Input para monto manual -->
                                    <div class="mb-3">
                                        <label class="block text-xs font-semibold text-gray-600 mb-1">O ingresa otro monto:</label>
                                        <input 
                                            type="number"
                                            id="customBillAmount"
                                            placeholder="Ej: 150"
                                            min="${cartTotal}"
                                            step="1"
                                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-base focus:border-green-500"
                                            onchange="selectCustomBill(this.value)">
                                    </div>
                                    
                                    ${state.selectedBill && state.selectedBill < cartTotal ? `
                                        <p class="text-red-600 font-bold text-sm">‚ö†Ô∏è El monto es menor al total</p>
                                    ` : ''}
                                    ${state.selectedBill && state.selectedBill >= cartTotal ? `
                                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-2">
                                            <p class="text-green-700 font-bold text-sm">‚úì Cambio: <span class="text-lg">L ${(state.selectedBill - cartTotal).toFixed(2)}</span></p>
                                        </div>
                                    ` : ''}
                                </div>

                                ${business.points_enabled ? `
                                    <div class="bg-blue-50 border border-blue-300 rounded-lg p-2 text-center mt-3">
                                        <p class="text-blue-800 font-bold text-sm">üéÅ Ganar√°s ${Math.floor(cartTotal / business.points_ratio)} puntos</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Footer compacto -->
                    <div class="bg-white border-t-2 border-green-500 px-3 py-3 shadow-xl">
                        <div class="flex items-center justify-between max-w-4xl mx-auto gap-2">
                            <div class="text-left">
                                <p class="text-gray-600 text-xs">Total:</p>
                                <p class="text-2xl font-display font-bold text-green-600">L ${cartTotal.toFixed(2)}</p>
                            </div>
                            <button 
                                onclick="confirmOrder()"
                                ${!state.customerName || !state.customerPhone || !state.selectedBill || state.selectedBill < cartTotal ? 'disabled' : ''}
                                class="${!state.customerName || !state.customerPhone || !state.selectedBill || state.selectedBill < cartTotal ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'btn-primary'} text-white px-6 py-3 rounded-xl font-display font-bold text-base">
                                ‚úì Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function ConfirmationScreen() {
            const cartTotal = getCartTotal();
            const change = state.selectedBill - cartTotal;
            const business = state.business;
            const pointsEarned = business.points_enabled ? Math.floor(cartTotal / business.points_ratio) : 0;
            
            return `
                <div class="h-screen flex items-center justify-center bg-gradient-to-br from-green-500 to-green-600 px-4 sm:px-6 lg:px-8 py-4 sm:py-6 fade-in">
                    <div class="w-full max-w-6xl">
                        <div class="bg-white rounded-2xl lg:rounded-3xl shadow-2xl p-4 sm:p-6 lg:p-8">
                            <!-- Header -->
                            <div class="text-center mb-4 sm:mb-6">
                                <div class="text-4xl sm:text-5xl lg:text-6xl mb-2">‚úÖ</div>
                                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-display font-bold text-gray-800">¬°Pedido Confirmado!</h1>
                                <p class="text-base sm:text-lg lg:text-xl text-gray-600 mt-1">Gracias por tu orden, ${state.customerName}</p>
                            </div>
                            
                            <!-- Contenido en 2 columnas -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-4 sm:mb-6">
                                <!-- N√∫mero de Orden -->
                                <div class="bg-blue-50 rounded-xl lg:rounded-2xl p-4 sm:p-5 lg:p-6 border-3 sm:border-4 border-blue-200 flex flex-col items-center justify-center">
                                    <p class="text-gray-600 text-sm sm:text-base lg:text-lg mb-1 sm:mb-2">Tu n√∫mero de orden es:</p>
                                    <p class="text-5xl sm:text-6xl lg:text-7xl font-display font-bold text-blue-900">#${state.orderNumber}</p>
                                </div>

                                <!-- Detalles de Pago -->
                                <div class="bg-gray-50 rounded-xl lg:rounded-2xl p-4 sm:p-5 lg:p-6 flex flex-col justify-center">
                                    <div class="flex justify-between items-center mb-3 sm:mb-4 pb-3 sm:pb-4 border-b-2 border-gray-300">
                                        <p class="text-base sm:text-lg lg:text-xl text-gray-600">Total:</p>
                                        <p class="text-2xl sm:text-2xl lg:text-3xl font-bold text-gray-800">L ${cartTotal.toFixed(2)}</p>
                                    </div>
                                    <div class="flex justify-between items-center mb-3 sm:mb-4 pb-3 sm:pb-4 border-b-2 border-gray-300">
                                        <p class="text-base sm:text-lg lg:text-xl text-gray-600">Pagar√°s con:</p>
                                        <p class="text-2xl sm:text-2xl lg:text-3xl font-bold text-blue-600">L ${state.selectedBill.toFixed(2)}</p>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <p class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-700">Tu cambio:</p>
                                        <p class="text-3xl sm:text-3xl lg:text-4xl font-bold text-green-600">L ${change.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>

                            ${pointsEarned > 0 ? `
                                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-3 border-yellow-400 rounded-xl lg:rounded-2xl p-4 sm:p-5 text-center mb-4 sm:mb-6">
                                    <p class="text-2xl font-bold text-yellow-800 mb-1">üéâ ¬°Felicidades!</p>
                                    <p class="text-lg text-yellow-700">Ganaste <strong class="text-2xl">${pointsEarned} puntos</strong> con esta compra</p>
                                </div>
                            ` : ''}

                            <!-- Footer con Siguiente Paso y Bot√≥n -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 items-center">
                                <div class="bg-yellow-50 border-3 sm:border-4 border-yellow-300 rounded-xl lg:rounded-2xl p-4 sm:p-5 text-center">
                                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-yellow-800 mb-1">üìç Siguiente paso:</p>
                                    <p class="text-sm sm:text-base lg:text-lg text-yellow-700">Pasa a caja a pagar tu orden</p>
                                </div>
                                
                                <button 
                                    onclick="resetApp()"
                                    class="btn-secondary text-white px-8 sm:px-10 lg:px-12 py-4 sm:py-5 lg:py-6 rounded-xl lg:rounded-2xl font-display font-bold text-lg sm:text-xl lg:text-2xl w-full">
                                    ‚Üê Volver al Inicio
                                </button>
                            </div>

                            <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                                <p class="text-sm text-gray-400">‚ö° Powered by <strong>Somar Totem</strong> ‚Ä¢ Part of <strong>Somar Ecosystem</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== FUNCIONES DE NAVEGACI√ìN ====================
        function startOrder() {
            state.screen = 'menu';
            render();
        }

        function changeCategory(categoryId) {
            state.activeCategory = categoryId;
            render();
        }

        function viewCart() {
            state.screen = 'cart';
            render();
        }

        function backToMenu() {
            state.screen = 'menu';
            render();
        }

        function backToCart() {
            state.screen = 'cart';
            render();
        }

        function proceedToCheckout() {
            state.screen = 'checkout';
            render();
        }

        function selectBill(amount) {
            state.selectedBill = amount;
            // Limpiar input de monto personalizado
            const customInput = document.getElementById('customBillAmount');
            if (customInput) customInput.value = '';
            render();
        }

        function selectCustomBill(amount) {
            const numAmount = parseFloat(amount);
            if (numAmount && numAmount > 0) {
                state.selectedBill = numAmount;
                render();
            }
        }

        async function confirmOrder() {
            // Capturar valores actuales de los inputs
            const nameInput = document.getElementById('customerName');
            const phoneInput = document.getElementById('customerPhone');
            
            if (nameInput) state.customerName = nameInput.value;
            if (phoneInput) state.customerPhone = phoneInput.value;
            
            if (!state.customerName || !state.customerPhone || !state.selectedBill) {
                alert('Por favor completa todos los campos');
                return;
            }

            if (state.selectedBill < getCartTotal()) {
                alert('El monto seleccionado es insuficiente');
                return;
            }

            await createOrder();
        }

        // ==================== RENDERIZADO ====================
        function render() {
            const app = document.getElementById('app');
            
            let content = '';
            switch(state.screen) {
                case 'loading':
                    content = LoadingScreen();
                    break;
                case 'error':
                    content = ErrorScreen();
                    break;
                case 'closed':
                    content = ClosedScreen();
                    break;
                case 'welcome':
                    content = WelcomeScreen();
                    break;
                case 'menu':
                    content = MenuScreen();
                    break;
                case 'cart':
                    content = CartScreen();
                    break;
                case 'checkout':
                    content = CheckoutScreen();
                    break;
                case 'confirmation':
                    content = ConfirmationScreen();
                    break;
                default:
                    content = LoadingScreen();
            }
            
            app.innerHTML = content;
        }

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadBusinessData();
        });

        // Prevenir zoom con pellizco (pero permitir scroll)
        document.addEventListener('touchmove', function(event) {
            if (event.scale !== undefined && event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // Prevenir doble tap zoom solo en elementos espec√≠ficos (no en todo el documento)
        // Comentado para permitir mejor interacci√≥n
        /*
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        */

        // Recargar datos cada 5 minutos para verificar si est√° abierto
        setInterval(() => {
            if (state.screen === 'welcome' || state.screen === 'closed') {
                loadBusinessData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
